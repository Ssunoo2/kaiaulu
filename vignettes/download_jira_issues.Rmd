---
title: "Download JIRA Issues and Comments"
output: 
  html_document:
    toc: true
    number_sections: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Download JIRA Issues and Commentss}
  %\VignetteEncoding{UTF-8}
---


```{r}
rm(list = ls())
seed <- 1
set.seed(seed)
```

```{r warning=FALSE,message=FALSE}
require(kaiaulu)
require(data.table)
require(knitr, quietly = T)
require(dplyr, quietly = T)
require(jsonlite)
```

# Introduction

This example is adapted from the JirAgileR package [README.md](https://github.com/matbmeijer/JirAgileR). 

As usual, the first step is to load the project configuration file. 

# Project Configuration File

In this notebook, we will obtain data from the issue tracker JIRA. We will use [Apache's Geronimo open source project](https://geronimo.apache.org). Refer to the `conf/` folder on Kaiaulu's git repository for Geronimo and other project configuration files. It is in this project configuration file we specify where Kaiaulu can find the jira sources from Geronimo. We will use the issue_tracker -> jira fields only. In regards to the "issues" and "issue_comments" fields, these should be set to paths where you want to store the jira data. Then, you can access this jira data later using these same paths.

# your_api_token is your atlassian token that is used as your password. This is optional but may be required depending on the project's permissions. Your username is your atlassian username (usually your email). These can be created by navigating to the indicated directories and creating a plain text file (vim atlassian_username or vim atlassian_token) and typing in your username and token. Details on how to obtain an atlassian token can be found here: https://support.atlassian.com/atlassian-account/docs/manage-api-tokens-for-your-atlassian-account/

```{r}
conf <- yaml::read_yaml("../conf/geronimo.yml")
# Project domain
issue_tracker_domain <- conf[["issue_tracker"]][["jira"]][["domain"]]
# Project key
issue_tracker_project_key <- conf[["issue_tracker"]][["jira"]][["project_key"]]
# Unaltered save paths from config file for use with refresh function
refresh_issues <- conf[["issue_tracker"]][["jira"]][["issues"]]
refresh_issue_comments <- conf[["issue_tracker"]][["jira"]][["issue_comments"]]
# Altered save paths. Important for naming conventions
save_path_issue_tracker_issues <- paste0(conf[["issue_tracker"]][["jira"]][["issues"]], issue_tracker_project_key, "_issues")
save_path_issue_tracker_issue_comments <- paste0(conf[["issue_tracker"]][["jira"]][["issue_comments"]], issue_tracker_project_key, "_issue_comments")
# Read the credentials from the file
# Assuming the first line is the username and the second line is the password
# Username: jondoe@jondoe.com
# Password: jondoespassword
credentials <- scan("~/.ssh/atlassian_credentials", what = "character", quiet = TRUE)
```

# Create the directories specified in the config files. 
# Directories will follow the form: ../../rawdata/issue_tracker/[project_key]/issues or ../../rawdata/issue_tracker/[project_key]/issues_comments

# If you have already created your directories, there is no need to run this chunk. 
```{r eval = FALSE}
# Check if the directory for issues exists, create if it doesn't
if (!dir.exists(refresh_issues)) {
  dir.create(refresh_issues)
  message("Directory ", refresh_issues, " created")
} else {
  message("Directory ", refresh_issues, " already exists")
}

# Check if the directory for issue comments exists, create if it doesn't
if (!dir.exists(refresh_issue_comments)) {
  dir.create(refresh_issue_comments)
  message("Directory ", refresh_issue_comments, " created")
} else {
  message("Directory ", refresh_issue_comments, " already exists")
}
```

# Download issues

This calls a function that interacts through the JIRA REST API through the rest/api/2/search endpoint. It authenticates requests with your username and api token. It also specifies the parameters passed to the API request including fields. maxResult is the number of issues downloaded per page, verbose when set to TRUE prints operational messages, and maxdownloadsPerHour sets an upper limit on how many issues will be downloaded within an hour before the function ceases API calls. 

```{r eval=FALSE}
all_issues <- download_jira_issues_comments(issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary", 
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate"), 
                           save_path_issue_tracker_issues, 
                           maxresults = 50, 
                           verbose = TRUE,
                           maxdownloads = 5000,
                           search_query = NULL)

# save all_issues as a json file along the path save_path_issue_tracker_issues
# jsonlite::write_json(all_issues, save_path_issue_tracker_issues)
```
#Download issues by specifying date created ranges

# Download issues with specified date ranges. This chunk allows the user to manipulate the functions date_lower_bound and date_upper_bound that retrieves only jira issues that were 'created' between these bounds. These parameters need to be specified in YYYY-MM-DD format. They are optional parameters to retrieve a range. If both are set to NULL, then all issues will be retrieved. An example is if date_lower_bound is set to "2000-01-01" and date_upper_bound is set to "2005-01-01", then only issues created between these two dates will be retrieved. The API call will have "AND created >= 2000-01-01 AND created <= 2005-01-01" appended to it before making a GET request. 

```{r}
# eg date_lower_bound <- "1970-01-01". Change these as you need
# Format is "yyyy/MM/dd HH:mm", "yyyy-MM-dd HH:mm", "yyyy/MM/dd", "yyyy-MM-dd"
# See https://support.atlassian.com/jira-software-cloud/docs/jql-fields/#Created for details
date_lower_bound <- "2012-01-01 12:31"
date_upper_bound <- NULL

all_issues <- download_jira_issues_comments_by_date (issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary", 
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate"), 
                           save_path_issue_tracker_issues, 
                           maxresults = 50, 
                           verbose = TRUE,
                           maxdownloads = 5000,
                           date_lower_bound,
                           date_upper_bound)

```
# Download issues by specifying issue key ranges

Download issues with specified date ranges. This chunk allows the user to manipulate the functions issuekey_lower_bound and issuekey_upper_bound that retrieves only jira issues with the issuekey between these bounds. These parameters need to be specified in accordance with the issuekey format relevant to your project. They are optional parameters to retrieve a range. If both are set to NULL, then all issues will be retrieved as the request will not be bounded. An example is if issuekey_lower_bound is set to "GERONIMO-740" and issuekey_upper_bound is set to "GERONIMO-6000", then only issues with issuekeys between these two issuekeys will be retrieved. The API call will have "AND issuekey >= GERONIMO-740 AND issuekey <= GERONIMO-6000" appended to it before making a GET request. It is important to note how the issue keys are formatted for your particular project. 

```{r}
# eg issuekey_lower_bound <- "GERONIMO-740"
issuekey_lower_bound <- "GERONIMO-740"
issuekey_upper_bound <- NULL

all_issues <- download_jira_issues_comments_by_issuekey (issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary", 
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate"), 
                           save_path_issue_tracker_issues, 
                           maxresults = 50, 
                           verbose = TRUE,
                           maxdownloads = 5000,
                           issuekey_lower_bound,
                           issuekey_upper_bound)

```

# Download only issues that you have not already downloaded (REFRESH)

# Acquires the filename of the file that contains the greatest 'created' data
```{r}
# placeholder value 
#file_name_with_greatest_issuekey <- "GERONIMO_issues_1121719349_1121802933.json"
file_name_with_greatest_issuekey <- parse_jira_latest_date(refresh_issues)
message("Filename with latest date: ", file_name_with_greatest_issuekey)
```
# Call the function that looks for the greatest issuekey in the file and then only downloads issues with issuekeys greater than that key
```{r}
refresh_jira_issues_comments_by_issuekey(
                           issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary", 
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate"), 
                           save_path_issue_tracker_issues, 
                           maxresults = 50, 
                           verbose = TRUE,
                           maxdownloads = 5000,
                           file_name_with_greatest_issuekey,
                           refresh_issues)

```

# Download Issue with Comments

In the same manner as before, we can perform the same function calls, but including the field `comment`. This will result in the same table being generated but with the additional comment information per issue (if an issue has more than one comment, the issue id is repeated for each different comment). The comment is shown on the column `comment_comments_id`. 

The data of this table can be used to calculate `social smell metrics`, as it represents a form of developer communication. A notebook discussing how to use JIRA data as communication network and/or combining to mailing list data will be made available in the future. 

Since this time around we requested the issue data and comments, when using the `parse_jira` function, both the issues and comments table will be available from the parser. Since the issue table was already displayed, the following show a few rows of the issue comments table:

# Call the function fetch_and_save_jira_issues (defined on line 55)
```{r eval=FALSE}
all_issues_comments <- download_jira_issues_comments(issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary",
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate",
                           "comment"), 
                           save_path_issue_tracker_issue_comments, 
                           maxresults = 50, 
                           verbose = TRUE,
                           maxdownloads = 5000,
                           search_query = NULL)
```

# Download issues with comments by specifying created range

```{r eval=FALSE}
# eg date_lower_bound <- "1970-01-01". Change these as you need
# Format is "yyyy/MM/dd HH:mm", "yyyy-MM-dd HH:mm", "yyyy/MM/dd", "yyyy-MM-dd"
# See https://support.atlassian.com/jira-software-cloud/docs/jql-fields/#Created for details
date_lower_bound <- "2012-01-01"
date_upper_bound <- NULL

all_issues_comments <- download_jira_issues_comments_by_date(issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary",
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate",
                           "comment"), 
                           save_path_issue_tracker_issue_comments, 
                           maxresults = 50, 
                           verbose = TRUE,
                           maxdownloads = 5000,
                           date_lower_bound,
                           date_upper_bound)
```


# Download issues with comments by specifying issuekey range

```{r eval=FALSE}
issuekey_lower_bound <- NULL
issuekey_upper_bound <- "GERONIMO-700"

all_issues_comments <- download_jira_issues_comments_by_issuekey(issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary",
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate",
                           "comment"), 
                           save_path_issue_tracker_issue_comments, 
                           maxresults = 50, 
                           verbose = TRUE,
                           maxdownloads = 5000,
                           issuekey_lower_bound,
                           issuekey_upper_bound)
```

# Download only issues with comments that you have not already downloaded (REFRESH)

 Acquires the filename of the file that contains the greatest 'created' data
```{r}
# placeholder value until parser is built
#file_name_with_greatest_issuekey_issue_comments <- "GERONIMO_issue_comments_1121646814_1121719175.json"
file_name_with_greatest_issuekey_issue_comments <- parse_jira_latest_date(refresh_issue_comments)
message("Filename with latest date: ", file_name_with_greatest_issuekey_issue_comments)
```
# Call the function that looks for the greatest issuekey in the file and then only downloads issues with issuekeys greater than that key
```{r}
refresh_jira_issues_comments_by_issuekey(
                           issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary",
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate",
                           "comment"), 
                           save_path_issue_tracker_issue_comments, 
                           maxresults = 50, 
                           verbose = TRUE,
                           maxdownloads = 5000,
                           file_name_with_greatest_issuekey_issue_comments,
                           refresh_issue_comments)

```
