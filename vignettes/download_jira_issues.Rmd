---
title: "Download JIRA Issues and Comments"
output: 
  html_document:
    toc: true
    number_sections: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Download JIRA Issues and Commentss}
  %\VignetteEncoding{UTF-8}
---


```{r}
rm(list = ls())
seed <- 1
set.seed(seed)
```

```{r warning=FALSE,message=FALSE}
require(kaiaulu)
require(data.table)
require(knitr, quietly = T)
require(dplyr, quietly = T)
require(jsonlite)
```

# Introduction

This example is adapted from the JirAgileR package [README.md](https://github.com/matbmeijer/JirAgileR). 

As usual, the first step is to load the project configuration file. 

# Project Configuration File

In this notebook, we will obtain data from the issue tracker JIRA. We will use [Apache's Geronimo open source project](https://geronimo.apache.org). Refer to the `conf/` folder on Kaiaulu's git repository for Geronimo and other project configuration files. It is in this project configuration file we specify where Kaiaulu can find the jira sources from Geronimo. We will use the issue_tracker -> jira fields only. In regards to the "issues" and "issue_comments" fields, these should be set to paths where you want to store the jira data. Then, you can access this jira data later using these same paths.

# your_api_token is your atlassian token that is used as your password. This is optional but may be required depending on the project's permissions. Your username is your atlassian username (usually your email). These can be created by navigating to the indicated directories and creating a plain text file (vim atlassian_username or vim atlassian_token) and typing in your username and token. Example format: 

Username: jondoe@jondoe.com
Password: jondoespassword

Details on [how to obtain an atlassian token](https://support.atlassian.com/atlassian-account/docs/manage-api-tokens-for-your-atlassian-account/)

```{r}
conf <- yaml::read_yaml("../conf/geronimo.yml")
# Project domain
issue_tracker_domain <- conf[["issue_tracker"]][["jira"]][["domain"]]
# Project key
issue_tracker_project_key <- conf[["issue_tracker"]][["jira"]][["project_key"]]
# Altered save paths. Important for naming conventions
save_path_issue_tracker_issues <- paste0(conf[["issue_tracker"]][["jira"]][["issues"]], issue_tracker_project_key, "_issues")
save_path_issue_tracker_issue_comments <- paste0(conf[["issue_tracker"]][["jira"]][["issue_comments"]], issue_tracker_project_key, "_issue_comments")
# Unaltered save paths from config file for use with refresh function
refresh_issues <- conf[["issue_tracker"]][["jira"]][["issues"]]
refresh_issue_comments <- conf[["issue_tracker"]][["jira"]][["issue_comments"]]
# Read the credentials from the file
# Assuming the first line is the username and the second line is the password
# Username: jondoe@jondoe.com
# Password: jondoespassword
credentials <- scan("~/.ssh/atlassian_credentials", what = "character", quiet = TRUE)
```

## Create the directories specified in the config files. 

The file schema of files for JIRA projects will be ../../rawdata/JIRA/project_name/issues or ../../rawdata/JIRA/project_name/issues_comments

If you have already created your directories, there is no need to run this chunk. 
```{r eval = FALSE}
# Check if the directory for issues exists, create if it doesn't
if (!dir.exists(refresh_issues)) {
  dir.create(refresh_issues)
  message("Directory ", refresh_issues, " created")
} else {
  message("Directory ", refresh_issues, " already exists")
}

# Check if the directory for issue comments exists, create if it doesn't
if (!dir.exists(refresh_issue_comments)) {
  dir.create(refresh_issue_comments)
  message("Directory ", refresh_issue_comments, " created")
} else {
  message("Directory ", refresh_issue_comments, " already exists")
}
```

## Download issues

This calls a function that downloads all issue data (without comments) from a repository specified in the config file. 

max_result is the number of issues downloaded per page, verbose when set to TRUE prints operational messages, and max_downloads sets an upper limit on how many issues will be downloaded within an hour before the function ceases API calls. You can change these values or keep them the same for simplicity. If there are more issues than the value of max_downloads, run the issue refresh function to continue downloading.

```{r eval=FALSE}
all_issues <- download_jira_issues(issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary", 
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate"), 
                           save_path_issue_tracker_issues, 
                           max_results = 50, 
                           max_total_downloads = 5000,
                           search_query = NULL,
                           verbose = TRUE)

# save all_issues as a json file along the path save_path_issue_tracker_issues
# jsonlite::write_json(all_issues, save_path_issue_tracker_issues)
```
## Download issues by date ranges

Download issues with specified date ranges. This chunk allows the user to manipulate the functions date_lower_bound and date_upper_bound that retrieves only jira issues that were ['created'](https://support.atlassian.com/jira-software-cloud/docs/jql-fields/#Created) between these bounds. They are optional parameters to retrieve a range. acceptable formats include: 

"yyyy/MM/dd HH:mm"
"yyyy-MM-dd HH:mm"
"yyyy/MM/dd"
"yyyy-MM-dd"

If both are set to NULL, then all issues will be retrieved. An example is if date_lower_bound is set to "2000-01-01" and date_upper_bound is set to "2005-01-01", then only issues created between these two dates will be retrieved. The API call will have "AND created >= 2000-01-01 AND created <= 2005-01-01" appended to it before retrieving data.

If you would like to retrieve issues only after a certain date, set date_upper_bound to NULL and date_lower_bound to the date. If you would like to retrieve only issues before a certain date, set date_lower_bound to NULL and date_upper_bound to the date. 

```{r}
# eg date_lower_bound <- "1970-01-01". Change these as you need
date_lower_bound <- "2015-01-01"
date_upper_bound <- "2020-01-01"

all_issues <- download_jira_issues_by_date (issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary", 
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate"), 
                           save_path_issue_tracker_issues, 
                           max_results = 50, 
                           max_total_downloads = 5000,
                           date_lower_bound,
                           date_upper_bound,
                           verbose = TRUE)

```
## Download issues by specifying issue key ranges

Download issues with specified date ranges. This chunk allows the user to manipulate the functions issue_key_lower_bound and issue_key_upper_bound that retrieves only JIRA issues with the issue key between these bounds. These parameters need to be specified in accordance with the issue key format relevant to your project. The default format is <project key>-<issue number>.

They are optional parameters to retrieve a range. If both are set to NULL, then all issues will be retrieved as the request will not be bounded. An example is if issue_key_lower_bound is set to "GERONIMO-740" and issue_key_upper_bound is set to "GERONIMO-6000", then only issues with issue keys between these two issue keys will be retrieved.

If issues with issue key greater than an issue key value are desired, set issue_key_upper_bound to NULL and issue_key_lower_bound to the issue key value. If issues with issue key less than an issue key value are desired, set issue_key_upper_bound to the issue key and issue_key_lower_bound to NULL. 

```{r}
# eg issueKey_lower_bound <- "GERONIMO-740"
issue_key_lower_bound <- "GERONIMO-500"
issue_key_upper_bound <- NULL

all_issues <- download_jira_issues_by_issue_key (issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary", 
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate"), 
                           save_path_issue_tracker_issues, 
                           max_results = 50, 
                           max_total_downloads = 5000,
                           issue_key_lower_bound,
                           issue_key_upper_bound,
                           verbose = TRUE)

```

## Refresh issue data

There are a few instances in which downloading the issue data does not capture all the issues. (1) The JIRA rest API rate limit (currently 5000/hour) is reached. (2) Function ends before completing. (3) max_downloads was set to a value lower than total issues. (4) more issues were committed after downloading. (5) etc. 

The issue refresh functionality allows only issues with issue key value greater than the greatest issue key value already downloaded to be downloaded. This allows us to 'continue' downloading if stopped early and download issues that were not downloaded already. If no issues have been downloaded and the file path is empty, it will download all issues.
```{r}
refresh_jira_issues(
                           issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary", 
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate"), 
                           save_path_issue_tracker_issues, 
                           max_results = 50, 
                           max_total_downloads = 5000,
                           refresh_issues,
                           verbose = TRUE)

```

## Download Issue with Comments

In the same manner as before, we can perform the same function calls, but including the field `comment`. This will result in the same table being generated but with the additional comment information per issue (if an issue has more than one comment, the issue id is repeated for each different comment). The comment is shown on the column `comment_comments_id`. 

The data of this table can be used to calculate `social smell metrics`, as it represents a form of developer communication. A notebook discussing how to use JIRA data as communication network and/or combining to mailing list data will be made available in the future. 

Since this time around we requested the issue data and comments, when using the `parse_jira` function, both the issues and comments table will be available from the parser. Since the issue table was already displayed, the following show a few rows of the issue comments table:

```{r eval=FALSE}
all_issues_comments <- download_jira_issues(issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary",
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate",
                           "comment"), 
                           save_path_issue_tracker_issue_comments, 
                           max_results = 50, 
                           max_total_downloads = 5000,
                           search_query = NULL,
                           verbose = TRUE)
```

## Download issues with comments by date ranges

This chunk is identical to downloading issue data by date range except that it also downloads comments. This chunk allows the user to manipulate the functions date_lower_bound and date_upper_bound that retrieves only jira issues with comments that were ['created'](https://support.atlassian.com/jira-software-cloud/docs/jql-fields/#Created) between these bounds. They are optional parameters to retrieve a range. acceptable formats include: 

"yyyy/MM/dd HH:mm"
"yyyy-MM-dd HH:mm"
"yyyy/MM/dd"
"yyyy-MM-dd"

If both are set to NULL, then all issues with comments will be retrieved. An example is if date_lower_bound is set to "2000-01-01" and date_upper_bound is set to "2005-01-01", then only issues with comments created between these two dates will be retrieved. The API call will have "AND created >= 2000-01-01 AND created <= 2005-01-01" appended to it before retrieving data

If you would like to retrieve issues with comments only after a certain date, set date_upper_bound to NULL and date_lower_bound to the date. If you would like to retrieve only issues with comments before a certain date, set date_lower_bound to NULL and date_upper_bound to the date. 

```{r eval=FALSE}
date_lower_bound <- "2020-01-01"
date_upper_bound <- NULL

all_issues_comments <- download_jira_issues_by_date(issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary",
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate",
                           "comment"), 
                           save_path_issue_tracker_issue_comments, 
                           max_results = 50, 
                           max_total_downloads = 5000,
                           date_lower_bound,
                           date_upper_bound,
                           verbose = TRUE)
```


## Download issues with comments by specifying issue key ranges

This chunk is identical to downloading issue data by issue key range except that it also downloads comments. This chunk allows the user to manipulate the functions issue_key_lower_bound and issue_key_upper_bound that retrieves only JIRA issues with comments with the issue key between these bounds. These parameters need to be specified in accordance with the issue key format relevant to your project. The default format is <project key>-<issue number>.

They are optional parameters to retrieve a range. If both are set to NULL, then all issues with comments will be retrieved as the request will not be bounded. An example is if issue_key_lower_bound is set to "GERONIMO-740" and issue_key_upper_bound is set to "GERONIMO-6000", then only issues with comments with issue keys between these two issue keys will be retrieved.

If issues with comments with issue key greater than an issue key value are desired, set issue_key_upper_bound to NULL and issue_key_lower_bound to the issue key value. If issues with comments with issue key less than an issue key value are desired, set issue_key_upper_bound to the issue key and issue_key_lower_bound to NULL. 

```{r eval=FALSE}
issue_key_lower_bound <- "GERONIMO-700"
issue_key_upper_bound <- NULL

all_issues_comments <- download_jira_issues_by_issue_key(issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary",
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate",
                           "comment"), 
                           save_path_issue_tracker_issue_comments, 
                           max_results = 50, 
                           max_total_downloads = 5000,
                           issue_key_lower_bound,
                           issue_key_upper_bound,
                           verbose = TRUE)
```

## Refresh issue data
This chunk is identical to refresh issue data except that it also downloads comments.

There are a few instances in which downloading the issue data with comments does not capture all the issues. (1) The JIRA rest API rate limit (currently 5000/hour) is reached. (2) Function ends before completing. (3) max_downloads was set to a value lower than total issues. (4) more issues were committed after downloading. (5) etc. 

The issue with comment refresh functionality allows only issues with comments with issue key value greater than the greatest issue key already downloaded to be downloaded. This allows us to 'continue' downloading if stopped early and download issues that were not downloaded already. If no issues have been downloaded and the file path is empty, it will download all issues.

```{r}
refresh_jira_issues(
                           issue_tracker_domain,
                           credentials, 
                           jql_query = paste0("project='",issue_tracker_project_key,"'"), 
                           fields = c("summary",
                           "description",
                           "creator",
                           "assignee",
                           "reporter",
                           "issuetype",
                           "status",
                           "resolution",
                           "components",
                           "created",
                           "updated",
                           "resolutiondate",
                           "comment"), 
                           save_path_issue_tracker_issue_comments, 
                           max_results = 50, 
                           max_total_downloads = 5000,
                           refresh_issue_comments,
                           verbose = TRUE)

```
